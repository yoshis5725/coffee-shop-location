import styles from '../styles/Home.module.css'
import Head from 'next/head'
import Banner from "@/components/banner/Banner";
import Image from "next/image";
import Card from "@/components/card/Card";
import {fetchCoffeeShops} from "../../utils/foursquare-utils";
import FindGeoLocation from "../../utils/geoLocation";
import {useContext, useEffect} from "react";
import {CoffeeStoreContext} from "../../contexts/coffee-store-context";
import {ACTION_TYPES} from "../../reducers/coffee-store-reducer";


/**
 * This function is used to fetch the coffee shops from the Foursquare API and pre-render the page
 * @returns {Promise<{props: {coffeeShops: {}}}>}
 */
export const getStaticProps = async () => {
    const coffeeShops = await fetchCoffeeShops();

    return {
        props: {
            coffeeShops: coffeeShops
        }
    };
};


const Home = (staticProps) => {
    const {coffeeShops} = staticProps;
    const {dispatch, state} = useContext(CoffeeStoreContext);
    const {localCoffeeStores, latLong} = state;
    const {getUsersLocation, locationErrorMsg, locatingUser, setLocationErrorMsg} = FindGeoLocation();


    // retrieving the users location on page load and setting the latLong state variable to the users location coordinates
    // this will trigger a re-render of the page and the useEffect hook will be called to fetch the local coffee shops
    useEffect(() => {
        if (latLong) {
            try {
                const fetchCoffeeShopsFromApi = async () => {
                    const localCoffeeShops = await fetchCoffeeShops(latLong);
                    dispatch(
                        {
                            type: ACTION_TYPES.SET_COFFEE_STORE,
                            payload: {localCoffeeStores: localCoffeeShops}
                        }
                    );
                };
                fetchCoffeeShopsFromApi();
            } catch (error) {
                setLocationErrorMsg(error.message);
            }
        }
    }, [dispatch, latLong, setLocationErrorMsg]);


    const onViewLocalStoresButtonClick = () => {
        getUsersLocation();
    };


    // *************************** JSX *************************** //
    return (
        <>
            <Head>
                <title>Coffee Connoisseur</title>
                <meta name="description" content="Generated by create next app"/>
                <meta name="viewport" content="width=device-width, initial-scale=1"/>
                <link rel="icon" href="/favicon.ico"/>
            </Head>
            <main className={styles.main}>
                <Banner
                    buttonText={locatingUser ? 'Finding your location' : 'View your local coffee shops'}
                    onClickHandler={onViewLocalStoresButtonClick}
                />

                {/*logic to display the location error message*/}
                {
                    locationErrorMsg && (
                        <p>Error: {locationErrorMsg}</p>
                    )
                }
                {/*end of logic to display the location error message*/}

                <Image src='/static/hero-image.png' alt='hero image' width={700} height={400}/>

                {/*logic displaying if there are coffee shops in the LOCAL AREA*/}
                {
                    localCoffeeStores.length > 0 && (
                        <div className={styles.sectionWrapper}>
                            <h2 className={styles.heading2}>Local Area Coffee Shops</h2>
                            <div className={styles.cardLayout}>
                                {/*mapping over the coffee shops*/}
                                {
                                    localCoffeeStores.map(coffeeShop => {
                                        const {id, name, imgUrl} = coffeeShop;
                                        return (
                                            <Card
                                                key={id}
                                                name={name}
                                                href={`/coffee-store/${id}`}
                                                imgUrl={imgUrl ? imgUrl : '/static/generic-coffee.jpg'}
                                            />
                                        );
                                    })
                                }
                                {/*end of coffee shops mapping*/}
                            </div>
                        </div>
                    )
                }
                {/*end of logic displaying if there are coffee shops in the LOCAL AREA*/}

                {/*logic displaying if there are coffee shops in DENVER*/}
                {
                    coffeeShops.length > 0 && (
                        <div className={styles.sectionWrapper}>
                            <h2 className={styles.heading2}>Denver Coffee Shops</h2>
                            <div className={styles.cardLayout}>
                                {/*mapping over the coffee shops*/}
                                {
                                    coffeeShops.map(coffeeShop => {
                                        const {id, name, imgUrl} = coffeeShop;
                                        return (
                                            <Card
                                                key={id}
                                                name={name}
                                                href={`/coffee-store/${id}`}
                                                imgUrl={imgUrl ? imgUrl : '/static/generic-coffee.jpg'}
                                            />
                                        );
                                    })
                                }
                                {/*end of coffee shops mapping*/}
                            </div>
                        </div>
                    )
                }
                {/*end of logic displaying if there are coffee shops in DENVER*/}
            </main>
        </>
    )
}


export default Home